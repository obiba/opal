<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:context="http://www.springframework.org/schema/context"
  xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd 
  http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-2.5.xsd">

  <context:annotation-config />

  <import resource="tx.xml" />
  <import resource="version.xml" />
  <import resource="hibernate-session.xml" />

  <bean id="opalDataSource" class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close">
    <property name="driverClassName" value="${org.obiba.opal.datasource.opal.driver}" />
    <property name="url" value="${org.obiba.opal.datasource.opal.url}" />
    <property name="username" value="${org.obiba.opal.datasource.opal.username}" />
    <property name="password" value="${org.obiba.opal.datasource.opal.password}" />
  </bean>

  <bean id="keyDataSource" class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close">
    <property name="driverClassName" value="${org.obiba.opal.datasource.key.driver}" />
    <property name="url" value="${org.obiba.opal.datasource.key.url}" />
    <property name="username" value="${org.obiba.opal.datasource.key.username}" />
    <property name="password" value="${org.obiba.opal.datasource.key.password}" />
  </bean>

  <bean class="org.springframework.beans.factory.config.CustomEditorConfigurer">
    <property name="customEditors">
      <map>
        <entry key="org.obiba.runtime.Version">
          <bean id="versionEditor" class="org.obiba.runtime.upgrade.support.VersionPropertyEditor" />
        </entry>
      </map>
    </property>
  </bean>

  <bean id="upgradeManager" class="org.obiba.runtime.upgrade.support.DefaultUpgradeManager">
    <property name="currentVersionProvider">
      <bean class="org.obiba.runtime.upgrade.support.JdbcVersionModifier">
        <property name="datasource" ref="opalDataSource" />
      </bean>
    </property>

    <property name="runtimeVersionProvider">
      <bean class="org.obiba.runtime.upgrade.VersionBeanVersionProvider">
        <property name="version" ref="version" />
      </bean>
    </property>

    <property name="newInstallationDetectionStrategy">
      <bean class="org.obiba.runtime.upgrade.support.EmptyDataSourceDetectionStrategy">
        <property name="dataSource" ref="opalDataSource" />
      </bean>
    </property>

    <property name="installSteps">
      <list>
        <bean class="org.obiba.runtime.upgrade.support.VersionTableInstallStep">
          <property name="dataSource" ref="opalDataSource" />
        </bean>
        <bean class="org.obiba.runtime.upgrade.InstallStepAdapter">
          <property name="upgradeStep">
            <bean class="org.obiba.runtime.upgrade.support.MethodInvokingUpgradeStep">
              <property name="description" value="Install Opal Schema." />
              <property name="methodOwner" ref="&amp;opalSessionFactory" />
              <property name="methodName" value="createDatabaseSchema" />
            </bean>
          </property>
        </bean>
        <bean class="org.obiba.runtime.upgrade.InstallStepAdapter">
          <property name="upgradeStep">
            <bean class="org.obiba.runtime.upgrade.support.MethodInvokingUpgradeStep">
              <property name="description" value="Install Key Schema." />
              <property name="methodOwner" ref="&amp;keySessionFactory" />
              <property name="methodName" value="createDatabaseSchema" />
            </bean>
          </property>
        </bean>
        <bean class="org.obiba.runtime.upgrade.InstallStepAdapter">
          <property name="upgradeStep">
            <bean class="org.obiba.runtime.upgrade.support.MethodInvokingUpgradeStep">
              <property name="description" value="Install Key Schema." />
              <property name="methodOwner" ref="&amp;keySessionFactory" />
              <property name="methodName" value="createDatabaseSchema" />
            </bean>
          </property>
        </bean>
        <bean class="org.obiba.runtime.upgrade.InstallStepAdapter">
          <property name="upgradeStep" ref="quartzSchema-1.4.0" />
        </bean>
        <bean class="org.obiba.opal.core.runtime.upgrade.CreateParticipantIdentifiersTableStep">
          <property name="keysSessionFactory" ref="keySessionFactory" />
        </bean>
        <!--  
        <bean id="createSpringBatchSchema" class="org.obiba.runtime.upgrade.InstallStepAdapter">
          <property name="upgradeStep">
            <bean class="org.obiba.runtime.upgrade.support.jdbc.SqlScriptUpgradeStep">
              <property name="description" value="Install Spring Batch Schema." />
              <property name="dataSource" ref="opalDataSource" />
              <property name="scriptPath" value="classpath:/META-INF/opal/install-scripts/spring-batch/" />
              <property name="scriptBasename" value="schema"/>
            </bean>
          </property>
        </bean>
         -->
      </list>
    </property>

    <property name="upgradeSteps">
      <list>
        <bean id="opal-schemaUpgrade-1.1" parent="updateOpalSchema">
          <property name="appliesTo" value="1.1" />  
        </bean>
        <ref bean="opal-dataUpgrade-1.1" />
        <ref bean="opal-viewsUpgrade-1.4.0" />
        <ref bean="quartzSchema-1.4.0" />
      </list>
    </property>

    <property name="stepListeners">
      <list>
        <bean class="org.obiba.runtime.upgrade.support.LoggingUpgradeManagerListener" />
      </list>
    </property>
  </bean>
    
  <bean id="updateOpalSchema" class="org.obiba.runtime.upgrade.support.MethodInvokingUpgradeStep" abstract="true">
    <property name="description" value="Update Opal Schema." />
    <property name="methodOwner" ref="&amp;opalSessionFactory" />
    <property name="methodName" value="updateDatabaseSchema" />
  </bean>
              
  <bean id="opal-dataUpgrade-1.1" class="org.obiba.runtime.upgrade.support.jdbc.SqlScriptUpgradeStep">
    <property name="dataSource" ref="opalDataSource" />
    <property name="scriptPath" value="classpath:/META-INF/opal/upgrade-scripts/" />
    <property name="scriptBasename" value="opal-dataUpgrade-1.1" />
    <property name="description" value="Copy 'DEFAULT_STUDY_ID' keystore from study_key_store to unit_key_store, then drop study_key_store."/>
    <property name="appliesTo" value="1.1" />     
  </bean>
  
  <bean id="opal-viewsUpgrade-1.4.0" class="org.obiba.opal.core.runtime.upgrade.ViewsUpgrade_1_4_0">
    <property name="description" value="Update action table 'type' field." />
    <property name="appliesTo" value="1.4.0" />
    <property name="configFile" value="${OPAL_HOME}/conf/opal-config.xml" />
  </bean>  
  
  <!--  The "1.4.0" here refers to the "appliesTo" Opal version, not the version of Quartz! -->
  <bean id="quartzSchema-1.4.0" class="org.obiba.runtime.upgrade.support.jdbc.SqlScriptUpgradeStep">
    <property name="description" value="Install Quartz Schema." />
    <property name="dataSource" ref="opalDataSource" />
    <property name="scriptPath" value="classpath:/META-INF/opal/install-scripts/quartz/" />
    <property name="scriptBasename" value="tables"/>
    <property name="appliesTo" value="1.4.0" />
  </bean>
  
</beans>