var RqlParser=function(){var that=this;this.operatorMap={"=":"eq","==":"eq",">":"gt",">=":"ge","<":"lt","<=":"le","!=":"ne"},this.commonOperatorMap={and:"&",or:"|",eq:"=",ne:"!=",le:"<=",ge:">=",lt:"<",gt:">"},this.primaryKeyName="id",this.lastSeen=["sort","select","values","limit"],this.jsonQueryCompatible=!0,this.autoConverted={"true":!0,"false":!1,"null":null,undefined:void 0,Infinity:1/0,"-Infinity":-(1/0)},this.converters={auto:function(string){if(that.autoConverted.hasOwnProperty(string))return that.autoConverted[string];var number=+string;return isNaN(number)||number.toString()!==string?(string=decodeURIComponent(string),that.jsonQueryCompatible&&"'"==string.charAt(0)&&"'"==string.charAt(string.length-1)?JSON.parse('"'+string.substring(1,string.length-1)+'"'):string):number},number:function(x){var number=+x;if(isNaN(number))throw new URIError("Invalid number "+number);return number},epoch:function(x){var date=new Date(+x);if(isNaN(date.getTime()))throw new URIError("Invalid date "+x);return date},isodate:function(x){var date="0000".substr(0,4-x.length)+x;return date+="0000-01-01T00:00:00Z".substring(date.length),that.converters.date(date)},date:function(x){var dDate,isoDate=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*)?)Z$/.exec(x);if(dDate=isoDate?new Date(Date.UTC(+isoDate[1],+isoDate[2]-1,+isoDate[3],+isoDate[4],+isoDate[5],+isoDate[6])):new Date(x),isNaN(dDate.getTime()))throw new URIError("Invalid date "+x);return dDate},"boolean":function(x){return"true"===x},string:function(string){return decodeURIComponent(string)},re:function(x){return new RegExp(decodeURIComponent(x),"i")},RE:function(x){return new RegExp(decodeURIComponent(x))},glob:function(x){var s=decodeURIComponent(x).replace(/([\\|\||\(|\)|\[|\{|\^|\$|\*|\+|\?|\.|\<|\>])/g,function(x){return"\\"+x}).replace(/\\\*/g,".*").replace(/\\\?/g,".?");return s=".*"!==s.substring(0,2)?"^"+s:s.substring(2),".*"!==s.substring(s.length-2)?s+="$":s=s.substring(0,s.length-2),new RegExp(s,"i")}},this.converters["default"]=this.converters.auto};RqlParser.prototype.parse=function(query,parameters){function call(newTerm){term.args.push(newTerm),term=newTerm,that.contains(that.lastSeen,term.name)&&(topTerm.cache[term.name]=term.args)}function setConjunction(operator){if(term.name){if(term.name!==operator)throw new Error("Can not mix conjunctions within a group, use paranthesis around each set of same conjuctions (& and |)")}else term.name=operator}function removeParentProperty(obj){if(obj&&obj.args){delete obj.parent;for(var args=obj.args,i=0,l=args.length;l>i;i++)removeParentProperty(args[i])}return obj}("undefined"==typeof query||null===query)&&(query="");var that=this,term=new RqlQuery,topTerm=term;if(topTerm.cache={},"object"==typeof query){if(query instanceof RqlQuery)return query;for(var i in query){var qTerm=new RqlQuery;topTerm.args.push(qTerm),qTerm.name="eq",qTerm.args=[i,query[i]]}return topTerm}if("?"==query.charAt(0))throw new URIError("Query must not start with ?");this.jsonQueryCompatible&&(query=query.replace(/%3C=/g,"=le=").replace(/%3E=/g,"=ge=").replace(/%3C/g,"=lt=").replace(/%3E/g,"=gt=")),query.indexOf("/")>-1&&(query=query.replace(/[\+\*\$\-:\w%\._]*\/[\+\*\$\-:\w%\._\/]*/g,function(slashed){return"("+slashed.replace(/\//g,",")+")"})),query=query.replace(/(\([\+\*\$\-:\w%\._,]+\)|[\+\*\$\-:\w%\._]*|)([<>!]?=(?:[\w]*=)?|>|<)(\([\+\*\$\-:\w%\._,]+\)|[\+\*\$\-:\w%\._]*|)/g,function(t,property,operator,value){if(operator.length<3){if(!that.operatorMap[operator])throw new URIError("Illegal operator "+operator);operator=that.operatorMap[operator]}else operator=operator.substring(1,operator.length-1);return operator+"("+property+","+value+")"}),"?"==query.charAt(0)&&(query=query.substring(1));var leftoverCharacters=query.replace(/(\))|([&\|,])?([\+\*\$\-:\w%\._]*)(\(?)/g,function(t,closedParan,delim,propertyOrValue,openParan){if(delim&&("&"===delim&&setConjunction("and"),"|"===delim&&setConjunction("or")),openParan){var newTerm=new RqlQuery;newTerm.name=propertyOrValue,newTerm.parent=term,call(newTerm)}else if(closedParan){var isArray=!term.name;if(term=term.parent,!term)throw new URIError("Closing paranthesis without an opening paranthesis");isArray&&term.args.push(term.args.pop().args)}else if((propertyOrValue||","===delim)&&(term.args.push(that.stringToValue(propertyOrValue,parameters)),that.contains(that.lastSeen,term.name)&&(topTerm.cache[term.name]=term.args),"eq"===term.name&&term.args[0]===that.primaryKeyName)){var id=term.args[1];!id||id instanceof RegExp||(id=id.toString()),topTerm.cache[that.primaryKeyName]=id}return""});if(term.parent)throw new URIError("Opening paranthesis without a closing paranthesis");if(leftoverCharacters)throw new URIError("Illegal character in query string encountered "+leftoverCharacters);return removeParentProperty(topTerm),topTerm},RqlParser.prototype.contains=function(array,item){for(var i=0,l=array.length;l>i;i++)if(array[i]===item)return!0},RqlParser.prototype.parseGently=function(){var terms;try{terms=this.parse.apply(this,arguments)}catch(err){terms=new RqlQuery,terms.error=err.message}return terms},RqlParser.prototype.stringToValue=function(str,parameters){var converter=this.converters["default"];if("$"===str.charAt(0)){var param_index=parseInt(str.substring(1))-1;return param_index>=0&&parameters?parameters[param_index]:void 0}if(str.indexOf(":")>-1){var parts=str.split(":",2);if(converter=this.converters[parts[0]],!converter)throw new URIError("Unknown converter "+parts[0]);str=parts[1]}return converter(str)};var RqlQuery=function(name){this.name=name||"and",this.args=[],this.knownOperators=["sort","in","not","any","all","or","and","select","exclude","values","limit","distinct","recurse","aggregate","between","sum","mean","max","min","count","first","one","eq","ne","le","ge","lt","gt"],this.knownScalarOperators=["mean","sum","min","max","count","first","one"],this.arrayMethods=["forEach","reduce","map","filter","indexOf","some","every"],this.parser=new RqlParser};RqlQuery.prototype.when=function(value,callback){callback(value)},RqlQuery.prototype.serializeArgs=function(array,delimiter){for(var results=[],i=0,l=array.length;l>i;i++)results.push(this.queryToString(array[i]));return results.join(delimiter)},RqlQuery.prototype.toString=function(){return"and"===this.name?this.serializeArgs(this.args,"&"):this.queryToString(this)},RqlQuery.prototype.queryToString=function(part){return part instanceof Array?"("+this.serializeArgs(part,",")+")":part&&part.name&&part.args?[part.name,"(",this.serializeArgs(part.args,","),")"].join(""):this.encodeValue(part)},RqlQuery.prototype.encodeString=function(s){return"string"==typeof s&&(s=encodeURIComponent(s),s.match(/[\(\)]/)&&(s=s.replace("(","%28").replace(")","%29"))),s},RqlQuery.prototype.encodeValue=function(val){var encoded;if(null===val&&(val="null"),val!==this.parser.converters["default"](""+(val.toISOString&&val.toISOString()||val.toString()))){var type=typeof val;if(val instanceof RegExp){val=val.toString();var i=val.lastIndexOf("/");type=val.substring(i).indexOf("i")>=0?"re":"RE",val=this.encodeString(val.substring(1,i)),encoded=!0}"object"===type&&(type="epoch",val=val.getTime(),encoded=!0),"string"===type&&(val=this.encodeString(val),encoded=!0),val=[type,val].join(":")}return encoded||"string"!=typeof val||(val=this.encodeString(val)),val},RqlQuery.prototype.updateQueryMethods=function(){var that=this;this.knownOperators.forEach(function(name){RqlQuery.prototype[name]=function(){var newQuery=new RqlQuery(void 0);newQuery.executor=that.executor;var newTerm=new RqlQuery(name);return newTerm.args=Array.prototype.slice.call(arguments),newQuery.args=that.args.concat([newTerm]),newQuery}}),this.knownScalarOperators.forEach(function(name){RqlQuery.prototype[name]=function(){var newQuery=new RqlQuery(void 0);newQuery.executor=that.executor;var newTerm=new RqlQuery(name);return newTerm.args=Array.prototype.slice.call(arguments),newQuery.args=that.args.concat([newTerm]),newQuery.executor(newQuery)}}),this.arrayMethods.forEach(function(name){RqlQuery.prototype[name]=function(){var args=arguments;return that.when(that.executor(that),function(results){return results[name].apply(results,args)})}})},RqlQuery.prototype.walk=function(fn,options){function walk(name,terms){(terms||[]).forEach(function(term,i,arr){var args,func;if(null!=term?term:term={},func=term.name,args=term.args,func&&args)if(args[0]instanceof RqlQuery)walk.call(this,func,args);else{var newTerm=fn.call(this,func,args);newTerm&&newTerm.name&&newTerm.args&&(arr[i]=newTerm)}})}options=options||{},walk.call(this,this.name,this.args)},RqlQuery.prototype.push=function(term){return this.args.push(term),this},RqlQuery.prototype.normalize=function(options){function normal(func,args){if("sort"===func||"select"===func){result[func]=args;var pm=plusMinus[func];result[func+"Arr"]=result[func].map(function(x){x instanceof Array&&(x=x.join("."));var o={},a=/([-+]*)(.+)/.exec(x);return o[a[2]]=pm[1*("-"===a[1].charAt(0)?1:0)],o}),result[func+"Obj"]={},result[func].forEach(function(x){x instanceof Array&&(x=x.join("."));var a=/([-+]*)(.+)/.exec(x);result[func+"Obj"][a[2]]=pm[1*("-"===a[1].charAt(0)?1:0)]})}else if("limit"===func){var limit=args;result.skip=+limit[1]||0,limit=+limit[0]||0,options.hardLimit&&limit>options.hardLimit&&(limit=options.hardLimit),result.limit=limit,result.needCount=!0}else if("values"===func)result.values=!0;else if("eq"===func){var t=typeof args[1];args[0]===options.primaryKey&&["string","number"].indexOf(t)>=0&&(result.pk=String(args[1]))}}options=options||{},options.primaryKey=options.primaryKey||"id",options.map=options.map||{};var result={original:this,sort:[],limit:[1/0,0,1/0],skip:0,limit:1/0,select:[],values:!1},plusMinus={sort:[1,-1],select:[1,0]};return this.walk(normal),result};var RqlArray=function(){var that=this;this.nextId=1,this.jsOperatorMap={eq:"===",ne:"!==",le:"<=",ge:">=",lt:"<",gt:">"},this.operators={sort:function(){for(var terms=[],i=0;i<arguments.length;i++){var sortAttribute=arguments[i],firstChar=sortAttribute.charAt(0),term={attribute:sortAttribute,ascending:!0};("-"==firstChar||"+"==firstChar)&&("-"==firstChar&&(term.ascending=!1),term.attribute=term.attribute.substring(1)),terms.push(term)}return this.sort(function(a,b){for(var term,i=0;term=terms[i];i++)if(a[term.attribute]!=b[term.attribute])return term.ascending==a[term.attribute]>b[term.attribute]?1:-1;return 0}),this},match:that.filter(function(value,regex){return new RegExp(regex,"i").test(value)}),matchcase:that.filter(function(value,regex){return new RegExp(regex).test(value)}),"in":that.filter(function(value,values){return that.contains(values,value)}),out:that.filter(function(value,values){return!that.contains(values,value)}),contains:that.filter(function(array,value){return"function"==typeof value?array instanceof Array&&that.each(array,function(v){return value.call([v]).length}):array instanceof Array&&that.contains(array,value)}),excludes:that.filter(function(array,value){return"function"==typeof value?!that.each(array,function(v){return value.call([v]).length}):!that.contains(array,value)}),or:function(){var items=[],idProperty="__rqlId"+that.nextId++;try{for(var i=0;i<arguments.length;i++)for(var group=arguments[i].call(this),j=0,l=group.length;l>j;j++){var item=group[j];item[idProperty]||(item[idProperty]=!0,items.push(item))}}finally{for(var i=0,l=items.length;l>i;i++)delete items[i][idProperty]}return items},and:function(){for(var items=this,i=0;i<arguments.length;i++)items=arguments[i].call(items);return items},select:function(){var args=arguments,argc=arguments.length;return that.each(this,function(object,emit){for(var selected={},i=0;argc>i;i++){var propertyName=args[i],value=that.evaluateProperty(object,propertyName);"undefined"!=typeof value&&(selected[propertyName]=value)}emit(selected)})},unselect:function(){var args=arguments,argc=arguments.length;return that.each(this,function(object,emit){var selected={};for(var i in object)object.hasOwnProperty(i)&&(selected[i]=object[i]);for(var i=0;argc>i;i++)delete selected[args[i]];emit(selected)})},values:function(first){if(1==arguments.length)return that.each(this,function(object,emit){emit(object[first])});var args=arguments,argc=arguments.length;return that.each(this,function(object,emit){var selected=[];if(0===argc)for(var i in object)object.hasOwnProperty(i)&&selected.push(object[i]);else for(var i=0;argc>i;i++){var propertyName=args[i];selected.push(object[propertyName])}emit(selected)})},limit:function(limit,start,maxCount){var totalCount=this.length;start=start||0;var sliced=this.slice(start,start+limit);return maxCount&&(sliced.start=start,sliced.end=start+sliced.length-1,sliced.totalCount=Math.min(totalCount,"number"==typeof maxCount?maxCount:1/0)),sliced},distinct:function(){var primitives={},needCleaning=[],newResults=this.filter(function(value){if(value&&"object"==typeof value){if(!value.__found__)return value.__found__=function(){},needCleaning.push(value),!0}else if(!primitives[value])return primitives[value]=!0,!0});return that.each(needCleaning,function(object){delete object.__found__}),newResults},recurse:function(property){function recurse(value){if(value instanceof Array)that.each(value,recurse);else if(newResults.push(value),property)value=value[property],value&&"object"==typeof value&&recurse(value);else for(var i in value)value[i]&&"object"==typeof value[i]&&recurse(value[i])}var newResults=[];return recurse(this),newResults},aggregate:function(){for(var distinctives=[],aggregates=[],i=0;i<arguments.length;i++){var arg=arguments[i];"function"==typeof arg?aggregates.push(arg):distinctives.push(arg)}var distinctObjects={},dl=distinctives.length;that.each(this,function(object){for(var key="",i=0;dl>i;i++)key+="/"+object[distinctives[i]];var arrayForKey=distinctObjects[key];arrayForKey||(arrayForKey=distinctObjects[key]=[]),arrayForKey.push(object)});var al=aggregates.length,newResults=[];for(var key in distinctObjects){for(var arrayForKey=distinctObjects[key],newObject={},i=0;dl>i;i++){var property=distinctives[i];newObject[property]=arrayForKey[0][property]}for(var i=0;al>i;i++){var aggregate=aggregates[i];newObject[i]=aggregate.call(arrayForKey)}newResults.push(newObject)}return newResults},between:that.filter(function(value,range){return value>=range[0]&&value<range[1]}),sum:that.reducer(function(a,b){return a+b}),mean:function(property){return that.operators.sum.call(this,property)/this.length},max:that.reducer(function(a,b){return Math.max(a,b)}),min:that.reducer(function(a,b){return Math.min(a,b)}),count:function(){return this.length},first:function(){return this[0]},one:function(){if(this.length>1)throw new TypeError("More than one object found");return this[0]}}};RqlArray.prototype.each=function(array,callback){var emit,result;callback.length>1&&(result=[],emit=function(value){result.push(value)});for(var i=0,l=array.length;l>i;i++)if(callback(array[i],emit))return result||!0;return result},RqlArray.prototype.contains=function(array,item){for(var i=0,l=array.length;l>i;i++)if(array[i]===item)return!0},RqlArray.prototype.stringify="undefined"!=typeof JSON&&JSON.stringify||function(str){return'"'+str.replace(/"/g,'\\"')+'"'},RqlArray.prototype.filter=function(condition,not){var that=this,filter=function(property,second){"undefined"==typeof second&&(second=property,property=void 0);for(var filtered=(arguments,[]),i=0,length=this.length;length>i;i++){var item=this[i];condition(that.evaluateProperty(item,property),second)&&filtered.push(item)}return filtered};return filter.condition=condition,filter},RqlArray.prototype.reducer=function(func){return function(property){var result=this[0];if(property){result=result&&result[property];for(var i=1,l=this.length;l>i;i++)result=func(result,this[i][property])}else for(var i=1,l=this.length;l>i;i++)result=func(result,this[i]);return result}},RqlArray.prototype.evaluateProperty=function(object,property){return property instanceof Array?(this.each(property,function(part){object=object[decodeURIComponent(part)]}),object):"undefined"==typeof property?object:object[decodeURIComponent(property)]},RqlArray.prototype.missingOperator=function(operator){throw new Error("Operator "+operator+" is not defined")},RqlArray.prototype.executeQuery=function(query,options,target){function T(){}function op(name){return operators[name]||that.missingOperator(name)}function queryToJS(value){if(value&&"object"==typeof value){if(value instanceof Array)return"["+that.each(value,function(value,emit){emit(queryToJS(value))})+"]";var jsOperator=that.jsOperatorMap[value.name];if(jsOperator){var item,path=value.args[0],target=value.args[1];if("undefined"==typeof target)item="item",target=path;else if(path instanceof Array){item="item";for(var escaped=[],i=0;i<path.length;i++)escaped.push(that.stringify(path[i])),item+="&&item["+escaped.join("][")+"]"}else item="item&&item["+that.stringify(path)+"]";var condition=item+jsOperator+queryToJS(target);return"function"==typeof Array.prototype.filter?"(function(){return this.filter(function(item){return "+condition+"})})":"(function(){var filtered = []; for(var i = 0, length = this.length; i < length; i++){var item = this[i];if("+condition+"){filtered.push(item);}} return filtered;})"}return value instanceof Date?value.valueOf():"(function(){return op('"+value.name+"').call(this"+(value&&value.args&&value.args.length>0?", "+that.each(value.args,function(value,emit){emit(queryToJS(value))}).join(","):"")+")})"}return"string"==typeof value?that.stringify(value):value}options=options||{};var that=this,parser=new RqlParser;query=parser.parse(query,options.parameters),T.prototype=this.operators;var operators=new T;for(var i in options.operators)operators[i]=options.operators[i];var evaluator=eval("(1&&function(target){return "+queryToJS(query)+".call(target);})");return target?evaluator(target):evaluator};